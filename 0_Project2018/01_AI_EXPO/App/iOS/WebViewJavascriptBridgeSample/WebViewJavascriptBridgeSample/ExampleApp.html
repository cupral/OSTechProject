<!doctype html>
<html><head>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0">
        <style type='text/css'>
            html { font-family:Helvetica; color:#222; }
            h1 { color:steelblue; font-size:24px; margin-top:24px; }
            button { margin:0 3px 10px; font-size:12px; }
            .logLine { border-bottom:1px solid #ccc; padding:4px 2px; font-family:courier; font-size:11px; }
            </style>

            <script type="text/javascript" src="jquery.min.js"></script>
            <script type="text/javascript" src="socket.io.min.js"></script>
            <script type="text/javascript" src="qi.js"></script>

</head><body>

    <h1>WebViewJavascriptBridge Demo</h1>
    <script>
        window.onerror = function(err) {
            log('window.onerror: ' + err)
        }

    // WebViewJavascriptBridgeのREADMEに記述されてた準備処理
    function setupWebViewJavascriptBridge(callback) {
        if (window.WebViewJavascriptBridge) { return callback(WebViewJavascriptBridge); }
        if (window.WVJBCallbacks) { return window.WVJBCallbacks.push(callback); }
        window.WVJBCallbacks = [callback];
        var WVJBIframe = document.createElement('iframe');
        WVJBIframe.style.display = 'none';
        WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__';
        document.documentElement.appendChild(WVJBIframe);
        setTimeout(function() { document.documentElement.removeChild(WVJBIframe) }, 0)
    }

    // bridgeさせたい処理はこの中に記述
    setupWebViewJavascriptBridge(function(bridge)
     {
       var uniqueId = 1
       function log(message, data) {
       var log = document.getElementById('log')
       var el = document.createElement('div')
       el.className = 'logLine'
       el.innerHTML = uniqueId++ + '. ' + message + ':<br/>' + JSON.stringify(data)
       if (log.children.length) { log.insertBefore(el, log.children[0]) }
       else { log.appendChild(el) }
     }

     var qiSession;
     var self = this;

     /** ObjCから叩かれるメソッドを登録 **/

     // pepperと通信を開始する
     bridge.registerHandler('startConnect', function(data, responseCallback) {
      log('Call Connnect to Pepper With IPAddress : ', data)
      qiSession = new QiSession(data);
      qiSession.socket().on('connect', function(){
        qiSession.service("ALTextToSpeech").done(function(tts){tts.say("接続しました。");})

        init();
        observe();
        var responseData = { 'Javascript Says':'Right back atcha!' }
        log('connect Success !!', responseData)
        responseCallback(responseData)
        })
      })

     // 挨拶コマンドを送る
    bridge.registerHandler('hello', function(data, responseCallback) {
      log('Call Send Command to next ')
      
      self.AnimatedSpeech.say("こんにちは。");
       self.BeManager.runBehavior("communicationdemo-/behavior_1");
      self.memory.raiseEvent("PepperEvent/rate", 50);
      self.memory.raiseEvent("PepperEvent/waiting", "");
      self.memory.raiseEvent("setStatusBar", 5);
      responseCallback("コールバックあれば渡す")
      })



      // restart
      bridge.registerHandler('restart', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/restart","");

        responseCallback("コールバックがあれば渡す")
      })



      // appStart
      bridge.registerHandler('appStart', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/appStart","");

        responseCallback("コールバックがあれば渡す")
      })




      // outputIP
      bridge.registerHandler('outputIP', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/outputIP","");

        responseCallback("コールバックがあれば渡す")
      })

      // qrDescription
      bridge.registerHandler('qrDescription', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/qrDescription","");

        responseCallback("コールバックがあれば渡す")
      })



      // identification
      bridge.registerHandler('identification', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        // data = ["0000001","Anzai Takayuki","1991","05","20"];
        self.memory.raiseEvent("PepperEvent/identification",data);

        responseCallback("コールバックがあれば渡す")
      })

      //guidance
      bridge.registerHandler('guidance', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/guidance","");

        responseCallback("コールバックがあれば渡す")
      })


      // personalInformation
      bridge.registerHandler('personalInformation', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/personalInformation","");

        responseCallback("コールバックがあれば渡す")
      })

      // attitude
      bridge.registerHandler('attitude', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/attitude","");

        responseCallback("コールバックがあれば渡す")
      })

      // notes
      bridge.registerHandler('notes', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/notes","");

        responseCallback("コールバックがあれば渡す")
      })

      // progress1
      bridge.registerHandler('progress1', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/progress1","");
        self.textToSpeech.stopAll();

        responseCallback("コールバックがあれば渡す")
      })

      // progress2
      bridge.registerHandler('progress2', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/progress2","");

        responseCallback("コールバックがあれば渡す")
      })

      // progress3
      bridge.registerHandler('progress3', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/progress3","");

        responseCallback("コールバックがあれば渡す")
      })

      // progress4
      bridge.registerHandler('progress4', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/progress4","");

        responseCallback("コールバックがあれば渡す")
      })

      // interviewStart
      bridge.registerHandler('interviewStart', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/interviewStart","");

        responseCallback("コールバックがあれば渡す")
      })

      // question
      bridge.registerHandler('question', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        // data = ["あなたが大学生の頃、一番頑張ったと思う活動などを教えてください。","\\rspd=95\\\\vct=115\\あなたが大学生の頃、一番頑張ったと思う活動などを教えてください。"]
        self.memory.raiseEvent("PepperEvent/question", data);
        console.log(data);

        responseCallback("コールバックがあれば渡す")
      })

      // hearing
      bridge.registerHandler('hearing', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/hearing","");

        responseCallback("コールバックがあれば渡す")
      })

      // suspended
      bridge.registerHandler('suspended', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/suspended","");

        responseCallback("コールバックがあれば渡す")
      })

      // suspendEnd
      bridge.registerHandler('suspendEnd', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/suspendEnd","");

        responseCallback("コールバックがあれば渡す")
      })

      // upload
      bridge.registerHandler('upload', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/upload", data);

        responseCallback("コールバックがあれば渡す")
      })

      // rate
      bridge.registerHandler('rate', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/rate", data);

        responseCallback("コールバックがあれば渡す")
      })

      // interviewFinish
      bridge.registerHandler('interviewFinish', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/interviewFinish","");

        responseCallback("コールバックがあれば渡す")
      })

      // appFinish
      bridge.registerHandler('appFinish', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/appFinish","");

        responseCallback("コールバックがあれば渡す")
      })

      // outputIP_close
      bridge.registerHandler('outputIP_close', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/outputIP_close","");
        self.textToSpeech.stopAll();
        window.setTimeout(function(){
          self.AnimatedSpeech.say("戻ります。");
        },1000);

        responseCallback("コールバックがあれば渡す")
      })

      //appError
      bridge.registerHandler('appError', function(data, responseCallback){
        log('Call send Command to  raiseEvent')
        self.memory.raiseEvent("PepperEvent/appError","");

        responseCallback("コールバックがあれば渡す")
      })


     /** init  **/

     //ALProxyのインスタンスを保持する
     function init(){

     log('初期化処理')


     qiSession.service("ALTextToSpeech").done(function(tts){
      self.textToSpeech = tts;
      tts.say("保持、成功しました");
      });
     qiSession.service("ALBehaviorManager").done(function(beMan){
      self.BeManager = beMan;
     });
     qiSession.service("ALAnimatedSpeech").done(function(anim){
      self.AnimatedSpeech = anim;
     });
     qiSession.service("ALMemory").done(function(am){
      self.memory = am;
      });
     };

     qiSession.service("ALMemory").done(function(alMemory){
// エラー報告
      alMemory.subscriber('PepperEvent/error').done(function(subscriber){subscriber.signal.connect(function(val){
      // イベントが発生すると呼び出される
        qiSession.service("ALTextToSpeech").done(function(tts){
         self.textToSpeech = tts;
         tts.say(val);
        });
       });
      });


    });

     /** observe  **/

     //ALMemoryのイベントのコールバックを登録する
     function observe(){
     log('イベントコールバック登録')
     qiSession.service("ALMemory").done(function(am){

      // コレグラフの「RaiseEvent」ボックスで登録した「PepperQiMessaging/test」イベントが発火したときに呼ばれる
      am.subscriber("PepperQiMessaging/test").done(function(subscriber){
       subscriber.signal.connect(function(value){

         /* 実行したい処理を呼び出す */
         bridge.callHandler('pepperEvent', {'foo': 'bar'}, function(response) {
          log('ペッパーイベント発火時のresponse', response)

          })
         });
       });

       // 後ろBumperを長押ししてアプリを終了された場合に発火するイベントを監視
       am.subscriber("PepperEvent/longTouchEnd").done(function(subscriber){
        subscriber.signal.connect(function(value){

          /* 実行したい処理を呼び出す */
          bridge.callHandler('pepperEvent', {'foo': 'bar'}, function(response) {
           log('BackBumper longTouchEnd', response)

           })
          });
        });

      });
     };

     document.body.appendChild(document.createElement('br'))

     /* js 発火用ボタン */
     var callbackButton = document.getElementById('buttons').appendChild(document.createElement('button'))
     callbackButton.innerHTML = 'JSでイベントを発生させるボタン'
     callbackButton.onclick = function(e) {
     e.preventDefault()

     log('jsEventという処理が叩かれます')

     bridge.callHandler('jsEvent', {'foo': 'bar'}, function(response) {
      log('jsEvent発火時のresponse', response)

      })
     }
     })
        </script>
    <div id='buttons'></div> <div id='log'></div>
</body></html>
